<div class="flex h-screen overflow-hidden bg-whatsapp-gray">
  <!-- Mobile Header with Hamburger Menu -->
  <div class="md:hidden fixed top-0 left-0 right-0 z-50 bg-whatsapp-dark border-b border-gray-700 h-14 flex items-center px-4">
    <button (click)="toggleMobileMenu()" class="text-gray-200 p-2 -ml-2 hover:bg-whatsapp-gray rounded-lg transition-colors">
      <i class="fas fa-bars text-xl"></i>
    </button>
    <div class="flex-1 flex items-center justify-center">
      <img src="/media/favicon.png" alt="Logo" class="w-8 h-8">
      <span class="text-gray-100 font-semibold text-sm ml-2">WhatsApp CRM</span>
    </div>
    <div class="w-10"></div> <!-- Spacer for centering -->
  </div>

  <!-- Mobile Menu Overlay -->
  <div *ngIf="mobileMenuOpen"
       (click)="closeMobileMenu()"
       class="md:hidden fixed inset-0 bg-black/50 z-50 transition-opacity"></div>

  <!-- Mobile Slide-out Navigation -->
  <div class="md:hidden fixed top-0 left-0 bottom-0 w-72 bg-whatsapp-dark z-50 transform transition-transform duration-300 flex flex-col"
       [class.-translate-x-full]="!mobileMenuOpen"
       [class.translate-x-0]="mobileMenuOpen">
    <!-- Mobile Nav Header -->
    <div class="h-14 flex items-center justify-between px-4 border-b border-gray-700">
      <div class="flex items-center gap-2">
        <img src="/media/favicon.png" alt="Logo" class="w-8 h-8">
        <span class="text-gray-100 font-semibold">WhatsApp CRM</span>
      </div>
      <button (click)="closeMobileMenu()" class="text-gray-400 hover:text-gray-200 p-2">
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>

    <!-- Mobile Nav Items -->
    <nav class="flex-1 py-4 px-3 flex flex-col gap-1 overflow-y-auto">
      <button
        (click)="navigateToConversations(); closeMobileMenu()"
        [class.bg-whatsapp-gray]="currentView === 'chat'"
        [class.text-whatsapp-green]="currentView === 'chat'"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all">
        <div class="relative flex-shrink-0">
          <i class="fas fa-comments text-xl"></i>
          <span *ngIf="unattendedCount > 0"
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 min-w-[1.25rem] flex items-center justify-center px-1">
            {{ unattendedCount }}
          </span>
        </div>
        <span class="font-medium">{{ 'navigation.conversations' | translate }}</span>
        <span *ngIf="unattendedCount > 0"
              class="ml-auto bg-red-500 text-white text-xs font-bold rounded-full px-2 py-0.5">
          {{ unattendedCount }}
        </span>
      </button>

      <button
        (click)="navigateToCustomers(); closeMobileMenu()"
        [class.bg-whatsapp-gray]="currentView === 'customers'"
        [class.text-whatsapp-green]="currentView === 'customers'"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all">
        <i class="fas fa-users text-xl flex-shrink-0"></i>
        <span class="font-medium">{{ 'navigation.customers' | translate }}</span>
      </button>

      <button
        (click)="navigateToTemplates(); closeMobileMenu()"
        [class.bg-whatsapp-gray]="currentView === 'templates'"
        [class.text-whatsapp-green]="currentView === 'templates'"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all">
        <i class="fas fa-file-alt text-xl flex-shrink-0"></i>
        <span class="font-medium">{{ 'navigation.templates' | translate }}</span>
      </button>

      <button
        *ngIf="currentAgent?.role === 'admin' || currentAgent?.role === 'supervisor'"
        (click)="navigateToAgents(); closeMobileMenu()"
        [class.bg-whatsapp-gray]="currentView === 'agents'"
        [class.text-whatsapp-green]="currentView === 'agents'"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all">
        <i class="fas fa-user-shield text-xl flex-shrink-0"></i>
        <span class="font-medium">{{ 'navigation.agents' | translate }}</span>
      </button>

      <button
        *ngIf="currentAgent?.role === 'admin' || currentAgent?.role === 'supervisor'"
        (click)="navigateToReports(); closeMobileMenu()"
        [class.bg-whatsapp-gray]="currentView === 'reports'"
        [class.text-whatsapp-green]="currentView === 'reports'"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all">
        <i class="fas fa-chart-bar text-xl flex-shrink-0"></i>
        <span class="font-medium">{{ 'navigation.reports' | translate }}</span>
      </button>

      <button
        (click)="navigateToSettings(); closeMobileMenu()"
        [class.bg-whatsapp-gray]="currentView === 'settings'"
        [class.text-whatsapp-green]="currentView === 'settings'"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all">
        <i class="fas fa-cog text-xl flex-shrink-0"></i>
        <span class="font-medium">{{ 'navigation.settings' | translate }}</span>
      </button>
    </nav>

    <!-- Mobile Profile Section -->
    <div class="border-t border-gray-700 p-3">
      <div class="flex items-center gap-3 px-4 py-3" *ngIf="currentAgent">
        <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-600 flex items-center justify-center flex-shrink-0">
          <img *ngIf="currentAgent.avatar" [src]="currentAgent.avatar" [alt]="currentAgent.firstName" class="w-full h-full object-cover">
          <span *ngIf="!currentAgent.avatar" class="text-white text-sm font-medium">
            {{ (currentAgent.firstName || 'A')[0] }}{{ (currentAgent.lastName || '')[0] }}
          </span>
        </div>
        <div class="flex-1 min-w-0">
          <span class="text-gray-100 text-sm font-medium block truncate">{{ currentAgent.firstName }} {{ currentAgent.lastName }}</span>
          <span class="text-xs text-gray-400 block truncate">{{ currentAgent.email }}</span>
        </div>
      </div>

      <!-- Auto-Assign Toggle -->
      <div class="px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3 text-gray-200">
            <i class="fas fa-user-clock w-5"></i>
            <span class="text-sm">{{ 'navigation.autoAssign' | translate }}</span>
          </div>
          <button
            (click)="toggleAutoAssign()"
            class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
            [ngClass]="currentAgent?.autoAssign ? 'bg-green-600' : 'bg-gray-600'">
            <span
              class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
              [ngClass]="currentAgent?.autoAssign ? 'translate-x-6' : 'translate-x-1'">
            </span>
          </button>
        </div>
      </div>

      <button (click)="logout(); closeMobileMenu()"
              class="w-full px-4 py-3 text-left hover:bg-red-900/30 transition-colors flex items-center gap-3 text-red-400 rounded-lg">
        <i class="fas fa-sign-out-alt w-5"></i>
        <span>{{ 'common.logout' | translate }}</span>
      </button>
    </div>
  </div>

  <!-- Left Navigation Sidebar (Collapsible) - Desktop Only -->
  <div class="hidden md:flex flex-col bg-whatsapp-dark border-r border-gray-700 shrink-0 transition-all duration-300"
       [class.w-60]="!sidebarCollapsed"
       [class.w-20]="sidebarCollapsed">
    <!-- Logo/Brand & Toggle -->
    <div class="h-16 flex items-center border-b border-gray-700 px-4"
         [class.justify-center]="sidebarCollapsed"
         [class.justify-between]="!sidebarCollapsed">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0">
          <img src="/media/favicon.png" alt="Logo" class="w-full h-full object-contain">
        </div>
        <div *ngIf="!sidebarCollapsed" class="flex flex-col">
          <span class="text-gray-100 font-semibold text-sm">WhatsApp CRM</span>
          <span class="text-gray-400 text-xs">Agent Portal</span>
        </div>
      </div>
      <button *ngIf="!sidebarCollapsed"
              (click)="toggleSidebar()"
              class="text-gray-400 hover:text-gray-200 p-1.5 rounded hover:bg-whatsapp-gray transition-colors"
              title="Collapse sidebar">
        <i class="fas fa-bars text-lg"></i>
      </button>
    </div>

    <!-- Navigation Items -->
    <nav class="flex-1 py-4 px-3 flex flex-col gap-1 overflow-y-auto">
      <button
        (click)="navigateToConversations()"
        [class.bg-whatsapp-gray]="currentView === 'chat'"
        [class.text-whatsapp-green]="currentView === 'chat'"
        [class.border-l-whatsapp-green]="currentView === 'chat'"
        [class.justify-center]="sidebarCollapsed"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all border-l-4 border-transparent group relative"
        [title]="sidebarCollapsed ? 'Conversations' : ''">
        <div class="relative flex-shrink-0">
          <i class="fas fa-comments text-xl"></i>
          <!-- Unattended notification badge (only when sidebar is collapsed) -->
          <span *ngIf="unattendedCount > 0 && sidebarCollapsed"
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 min-w-[1.25rem] flex items-center justify-center px-1 animate-pulse shadow-lg">
            {{ unattendedCount }}
          </span>
        </div>
        <span *ngIf="!sidebarCollapsed" class="font-medium">{{ 'navigation.conversations' | translate }}</span>
        <!-- Badge at the end when sidebar is expanded -->
        <span *ngIf="!sidebarCollapsed && unattendedCount > 0"
              class="ml-auto bg-red-500 text-white text-xs font-bold rounded-full px-2 py-0.5 animate-pulse">
          {{ unattendedCount }}
        </span>
      </button>

      <button
        (click)="navigateToCustomers()"
        [class.bg-whatsapp-gray]="currentView === 'customers'"
        [class.text-whatsapp-green]="currentView === 'customers'"
        [class.border-l-whatsapp-green]="currentView === 'customers'"
        [class.justify-center]="sidebarCollapsed"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all border-l-4 border-transparent group"
        [title]="sidebarCollapsed ? ('navigation.customers' | translate) : ''">
        <i class="fas fa-users text-xl flex-shrink-0"></i>
        <span *ngIf="!sidebarCollapsed" class="font-medium">{{ 'navigation.customers' | translate }}</span>
      </button>

      <button
        (click)="navigateToTemplates()"
        [class.bg-whatsapp-gray]="currentView === 'templates'"
        [class.text-whatsapp-green]="currentView === 'templates'"
        [class.border-l-whatsapp-green]="currentView === 'templates'"
        [class.justify-center]="sidebarCollapsed"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all border-l-4 border-transparent group"
        [title]="sidebarCollapsed ? ('navigation.templates' | translate) : ''">
        <i class="fas fa-file-alt text-xl flex-shrink-0"></i>
        <span *ngIf="!sidebarCollapsed" class="font-medium">{{ 'navigation.templates' | translate }}</span>
      </button>

      <button
        *ngIf="currentAgent?.role === 'admin' || currentAgent?.role === 'supervisor'"
        (click)="navigateToAgents()"
        [class.bg-whatsapp-gray]="currentView === 'agents'"
        [class.text-whatsapp-green]="currentView === 'agents'"
        [class.border-l-whatsapp-green]="currentView === 'agents'"
        [class.justify-center]="sidebarCollapsed"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all border-l-4 border-transparent group"
        [title]="sidebarCollapsed ? ('navigation.agents' | translate) : ''">
        <i class="fas fa-user-shield text-xl flex-shrink-0"></i>
        <span *ngIf="!sidebarCollapsed" class="font-medium">{{ 'navigation.agents' | translate }}</span>
      </button>

      <button
        *ngIf="currentAgent?.role === 'admin' || currentAgent?.role === 'supervisor'"
        (click)="navigateToReports()"
        [class.bg-whatsapp-gray]="currentView === 'reports'"
        [class.text-whatsapp-green]="currentView === 'reports'"
        [class.border-l-whatsapp-green]="currentView === 'reports'"
        [class.justify-center]="sidebarCollapsed"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all border-l-4 border-transparent group"
        [title]="sidebarCollapsed ? ('navigation.reports' | translate) : ''">
        <i class="fas fa-chart-bar text-xl flex-shrink-0"></i>
        <span *ngIf="!sidebarCollapsed" class="font-medium">{{ 'navigation.reports' | translate }}</span>
      </button>
    </nav>

    <!-- Bottom Navigation (Settings, Profile) -->
    <div class="border-t border-gray-700 p-3 flex flex-col gap-1">
      <button
        (click)="navigateToSettings()"
        [class.bg-whatsapp-gray]="currentView === 'settings'"
        [class.text-whatsapp-green]="currentView === 'settings'"
        [class.border-l-whatsapp-green]="currentView === 'settings'"
        [class.justify-center]="sidebarCollapsed"
        class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all border-l-4 border-transparent"
        [title]="sidebarCollapsed ? ('navigation.settings' | translate) : ''">
        <i class="fas fa-cog text-xl flex-shrink-0"></i>
        <span *ngIf="!sidebarCollapsed" class="font-medium">{{ 'navigation.settings' | translate }}</span>
      </button>

      <!-- Collapse Button (when expanded) -->
      <button *ngIf="sidebarCollapsed"
              (click)="toggleSidebar()"
              class="flex items-center justify-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all"
              title="Expand sidebar">
        <i class="fas fa-bars text-xl"></i>
      </button>

      <!-- Profile Button -->
      <div class="relative">
        <button
          #profileButton
          (click)="toggleMenu()"
          [class.justify-center]="sidebarCollapsed"
          class="w-full flex items-center gap-3 px-4 py-3 text-gray-400 hover:text-gray-200 hover:bg-whatsapp-gray rounded-lg transition-all"
          title="Profile & Account">
          <div class="w-8 h-8 rounded-full overflow-hidden bg-gray-600 flex items-center justify-center flex-shrink-0" *ngIf="currentAgent">
            <img *ngIf="currentAgent.avatar" [src]="currentAgent.avatar" [alt]="currentAgent.firstName" class="w-full h-full object-cover">
            <span *ngIf="!currentAgent.avatar" class="text-white text-xs font-medium">
              {{ (currentAgent.firstName || 'A')[0] }}{{ (currentAgent.lastName || '')[0] }}
            </span>
          </div>
          <div *ngIf="!sidebarCollapsed && currentAgent" class="flex flex-col items-start min-w-0 flex-1">
            <span class="text-gray-100 text-sm font-medium truncate w-full">{{ currentAgent.firstName }} {{ currentAgent.lastName }}</span>
            <span class="text-xs text-gray-400 truncate w-full">{{ currentAgent.email }}</span>
          </div>
          <i *ngIf="!sidebarCollapsed" class="fas fa-ellipsis-v text-sm flex-shrink-0"></i>
        </button>

        <!-- Profile Dropdown Menu (positioned relative to button) -->
        <div *ngIf="showMenu"
             class="absolute bottom-full mb-2 left-0 z-50 w-72 bg-whatsapp-dark border border-gray-700 rounded-lg shadow-2xl py-2">
          <div class="px-4 py-3 border-b border-gray-700">
            <div class="flex items-center gap-3" *ngIf="currentAgent">
              <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-600 flex-shrink-0">
                <img *ngIf="currentAgent.avatar" [src]="currentAgent.avatar" [alt]="currentAgent.firstName" class="w-full h-full object-cover">
                <div *ngIf="!currentAgent.avatar" class="w-full h-full flex items-center justify-center text-white font-medium">
                  {{ (currentAgent.firstName || 'A')[0] }}{{ (currentAgent.lastName || '')[0] }}
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <h3 class="text-gray-100 font-medium text-sm truncate">{{ currentAgent.firstName }} {{ currentAgent.lastName }}</h3>
                <p class="text-xs text-gray-400 truncate">{{ currentAgent.email }}</p>
              </div>
            </div>
          </div>

          <button (click)="viewProfile()"
                  class="w-full px-4 py-3 text-left hover:bg-whatsapp-gray transition-colors flex items-center gap-3 text-gray-200">
            <i class="fas fa-user w-5"></i>
            <span>{{ 'navigation.myProfile' | translate }}</span>
          </button>

          <div class="border-t border-gray-700 my-2"></div>

          <!-- Auto-Assign Toggle -->
          <div class="px-4 py-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3 text-gray-200">
                <i class="fas fa-user-clock w-5"></i>
                <span class="text-sm">{{ 'navigation.autoAssign' | translate }}</span>
              </div>
              <button
                (click)="toggleAutoAssign()"
                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                [ngClass]="currentAgent?.autoAssign ? 'bg-green-600' : 'bg-gray-600'">
                <span
                  class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                  [ngClass]="currentAgent?.autoAssign ? 'translate-x-6' : 'translate-x-1'">
                </span>
              </button>
            </div>
            <p class="text-xs text-gray-400 mt-1 ml-8">
              {{ currentAgent?.autoAssign ? ('navigation.online' | translate) : ('navigation.offline' | translate) }}
            </p>
          </div>

          <div class="border-t border-gray-700 my-2"></div>

          <button (click)="logout()"
                  class="w-full px-4 py-3 text-left hover:bg-red-900/30 transition-colors flex items-center gap-3 text-red-400">
            <i class="fas fa-sign-out-alt w-5"></i>
            <span>{{ 'common.logout' | translate }}</span>
          </button>
        </div>

        <!-- Overlay to close menu -->
        <div *ngIf="showMenu"
             (click)="closeMenu()"
             class="fixed inset-0 z-40"></div>
      </div>
    </div>
  </div>

  <!-- Content Area Sidebar (Chat List or Other Views) -->
  <div class="w-full md:w-auto md:flex flex-col border-r border-gray-700 bg-whatsapp-dark relative pt-14 md:pt-0"
       [ngClass]="{'hidden md:flex': hasSelectedChat && currentView === 'chat'}"
       [style.width.px]="isDesktop ? sidebarWidth : null"
       *ngIf="currentView === 'chat'">
    <!-- User Profile Header -->
    <div class="bg-whatsapp-gray px-4 py-3 border-b border-gray-700 shrink-0">
      <div class="flex items-center justify-between">
        <h2 class="text-gray-100 font-semibold text-lg">Conversations</h2>
        <div class="relative flex-shrink-0">
          <button
                  class="text-gray-400 hover:text-gray-200 transition-colors p-2 rounded-full hover:bg-whatsapp-dark"
                  title="New Chat">
            <i class="fas fa-plus text-lg"></i>
          </button>
        </div>
      </div>
    </div>

    <app-chat-list class="flex-1 overflow-hidden"></app-chat-list>

    <!-- Resize Handle -->
    <div class="hidden md:flex absolute top-0 right-0 w-2 h-full cursor-col-resize hover:bg-whatsapp-green/50 transition-all z-20 items-center justify-center"
         (mousedown)="startResize($event)"
         [class.bg-whatsapp-green]="isResizing"
         [class.w-1]="isResizing">
      <div class="w-0.5 h-16 bg-gray-500 hover:bg-whatsapp-green rounded-full transition-colors"
           [class.bg-whatsapp-green]="isResizing"></div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="flex flex-1 flex-col bg-whatsapp-dark relative pt-14 md:pt-0 min-w-0 overflow-hidden"
       [ngClass]="{'flex': hasSelectedChat || currentView !== 'chat', 'hidden md:flex': !hasSelectedChat && currentView === 'chat'}">

    <!-- Show Chat Window when in chat view -->
    <ng-container *ngIf="currentView === 'chat'">
      <!-- Background Pattern -->
      <div class="absolute inset-0 opacity-5 pointer-events-none"
           style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');">
      </div>

      <app-chat-window class="flex-1 overflow-hidden z-10"></app-chat-window>
    </ng-container>

    <!-- Show Router Outlet for other views (customers, templates, agents, reports, settings) -->
    <ng-container *ngIf="currentView !== 'chat'">
      <router-outlet></router-outlet>
    </ng-container>
  </div>
</div>
