# Azure Deployment Plan for whatsapp-meta-bot Project

## **Goal**
Deploy the WhatsApp Meta Bot Node.js application to Azure App Service with MongoDB (Azure Cosmos DB) backend using Azure Developer CLI (azd).

## **Project Information**
**whatsapp-meta-bot**  
- **Stack**: Node.js >= 22.0.0, Express.js, Socket.io  
- **Type**: WhatsApp Bot with webhook handlers and OpenAI Assistant integration  
- **Containerization**: Not yet containerized  
- **Dependencies**: MongoDB (will use Azure Cosmos DB), OpenAI Assistant API  
- **Hosting**: Azure App Service (Linux, Node.js runtime)

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TB
    WhatsApp[WhatsApp Cloud API] -->|Webhook Events| AppService[Azure App Service]
    AppService -->|AI Responses| OpenAI[OpenAI Assistant API]
    AppService -->|Data Storage| CosmosDB[(Azure Cosmos DB for MongoDB)]
    AppService -->|Logs & Metrics| AppInsights[Application Insights]
    AppService -->|Secrets| KeyVault[Azure Key Vault]
    AppService -->|Identity| ManagedID[User-Assigned Managed Identity]
    KeyVault -->|Access Control| ManagedID
    LogAnalytics[Log Analytics Workspace] -->|Collects Logs| AppService
    LogAnalytics -->|Metrics| AppInsights
```

**Resource Relations:**
- The App Service hosts the Node.js WhatsApp bot application
- The App Service connects to Azure Cosmos DB (MongoDB API) for data persistence
- The App Service uses User-Assigned Managed Identity to access Key Vault secrets
- Application Insights monitors performance and logs
- Key Vault stores sensitive connection strings and API keys
- Log Analytics Workspace aggregates all logs from App Service

## **Recommended Azure Resources**

### Application: whatsapp-meta-bot
- **Hosting Service Type**: Azure App Service (Linux)
- **SKU**: B1 (Basic) - 1 vCPU, 1.75 GB RAM, suitable for small production workloads with moderate traffic
- **Configuration**:
    - **Language**: Node.js 22 LTS
    - **Environment Variables**:
        - `PORT` (default: 3000)
        - `MONGODB` (from Key Vault: Cosmos DB connection string)
        - `WHATSAPP_URI`
        - `WHATSAPP_VERSION`
        - `WHATSAPP_PHONE_NUMBER_ID`
        - `WHATSAPP_API_TOKEN` (from Key Vault)
        - `WHATSAPP_ACCESS_TOKEN` (from Key Vault)
        - `WHATSAPP_ADMIN`
        - `OPENAI_API_KEY` (from Key Vault)
        - `OPENAI_ASSISTANT_ID`
        - `APPLICATIONINSIGHTS_CONNECTION_STRING` (auto-injected)

### Dependencies:

#### Azure Cosmos DB for MongoDB
- **SKU**: Serverless - Auto-scales based on usage, pay-per-request pricing, ideal for variable workloads
- **Service Type**: Azure Cosmos DB (MongoDB API)
- **Connection Type**: Connection string stored in Key Vault, accessed via Managed Identity
- **Environment Variables**:
    - `MONGODB` - Connection string from Key Vault

## **Recommended Supporting Services**

- **Application Insights**: Monitor application performance, logs, and exceptions
- **User-Assigned Managed Identity**: Secure authentication to Azure services without credentials
- **Log Analytics Workspace**: Centralized logging for App Service and Application Insights
- **Key Vault**: Store sensitive secrets (connection strings, API keys)
    - Secrets to store:
        - `MONGODB-CONNECTION-STRING`
        - `WHATSAPP-API-TOKEN`
        - `WHATSAPP-ACCESS-TOKEN`
        - `OPENAI-API-KEY`

## **Recommended Security Configurations**

- User-Assigned Managed Identity must have **Key Vault Secrets User** role on the Key Vault
- User-Assigned Managed Identity must be assigned to the App Service
- Key Vault should have **RBAC** enabled (no access policies)
- App Service should use **HTTPS only**
- Cosmos DB should have **firewall rules** to allow only App Service
- Disable key-based authentication for Cosmos DB; use RBAC where possible

## **Execution Steps**

> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan. Add check list for the steps.**

### 1. Provision Azure Infrastructure with AZD:
   - [ ] 1.1. **Provisioning tool**: AZD. Expected files: `azure.yaml`, `infra/main.bicep`, `infra/main.parameters.json`
   - [ ] 1.2. Get subscription ID and preferred regions. Call tool `appmod-get-regions-with-sufficient-quota` to verify region and SKU availability for:
       - `Microsoft.Web/sites` (App Service)
       - `Microsoft.DocumentDB/databaseAccounts` (Cosmos DB)
       - `Microsoft.KeyVault/vaults`
       - `Microsoft.Insights/components`
   - [ ] 1.3. Check if expected files exist:
       - **If files exist**: Validate they match requirements in this plan
       - **If files do NOT exist**: Generate them using `appmod-get-iac-rules` tool
   - [ ] 1.4. Generate missing files:
       - `azure.yaml` - AZD configuration
       - `infra/main.bicep` - Infrastructure as Code
       - `infra/main.parameters.json` - Parameter values
   - [ ] 1.5. Call `get_errors` on generated Bicep files to validate syntax
   - [ ] 1.6. Run `azd provision --preview --no-prompt` to dry-run infrastructure deployment
   - [ ] 1.7. Fix any errors in Bicep files using `get_errors` tool and retry

### 2. Environment Setup for AZD:
   - [ ] 2.1. Verify AZ CLI and AZD are installed (or guide user to install)
   - [ ] 2.2. Run `azd env new whatsapp-bot-env --no-prompt` to create environment
   - [ ] 2.3. Set required environment variables using `azd env set`:
       - `AZURE_SUBSCRIPTION_ID`
       - `AZURE_LOCATION` (e.g., eastus, westus2)
       - `WHATSAPP_URI`
       - `WHATSAPP_VERSION`
       - `WHATSAPP_PHONE_NUMBER_ID`
       - `WHATSAPP_ADMIN`
       - `OPENAI_ASSISTANT_ID`
   - [ ] 2.4. Set secrets (will be stored in Key Vault):
       - `WHATSAPP_API_TOKEN`
       - `WHATSAPP_ACCESS_TOKEN`
       - `OPENAI_API_KEY`

### 3. Deployment:
   - [ ] 3.1. Run `azd up --no-prompt` to provision and deploy
   - [ ] 3.2. If errors occur, iterate and fix:
       - Check Bicep syntax errors
       - Verify quota availability
       - If region change needed: run `azd down --force --no-prompt` first
   - [ ] 3.3. Validate deployment:
       - Use `appmod-get-azd-app-logs` tool to check application logs
       - Verify App Service is running
       - Test webhook endpoint availability

### 4. Summarize Deployment Result:
   - [ ] 4.1. Use `appmod-summarize-result` tool to generate summary
   - [ ] 4.2. Generate file: `.azure/summary.copilotmd`
   - [ ] 4.3. Provide user with:
       - App Service URL
       - Resource group link
       - WhatsApp webhook configuration instructions

## **Progress Tracking**

Track progress in `.azure/progress.copilotmd`:

- ‚úÖ Completed tasks
- üî≤ Pending tasks
- ‚ùå Failed tasks with error notes

**Example format:**
```
- [x] Deployment plan created
- [ ] Azure infrastructure provisioning
  - Attempt 1: Checking quota availability...
- [ ] Environment configuration
- [ ] Application deployment
- [ ] Validation and testing
```

## **Post-Deployment Configuration**

After successful deployment:

1. **Configure WhatsApp Webhook**:
   - Go to Meta for Developers portal
   - Set webhook URL to: `https://<app-service-url>/api/v2`
   - Set verify token to match `WHATSAPP_ACCESS_TOKEN`

2. **Test the Bot**:
   - Send a test message to your WhatsApp number
   - Verify OpenAI Assistant responds
   - Check Application Insights for logs

3. **Monitor**:
   - Application Insights dashboard
   - Log Analytics queries
   - App Service metrics
