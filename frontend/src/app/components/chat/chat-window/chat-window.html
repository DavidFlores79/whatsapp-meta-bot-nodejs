<div class="flex flex-col h-full bg-whatsapp-image bg-repeat" *ngIf="selectedChat$ | async as chat; else noChat">
    <!-- Header -->
    <div class="h-auto bg-whatsapp-gray flex flex-col border-b border-gray-700 shrink-0 z-10">
        <div class="flex items-center justify-between px-4 py-2">
            <div class="flex items-center cursor-pointer" (click)="openCustomerModal(chat)" [title]="'chat.viewEditCustomer' | translate">
                <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
                    <img [src]="chat.avatar" [alt]="chat.name" class="w-full h-full object-cover">
                </div>
                <div>
                    <h3 class="text-gray-100 font-medium">{{ chat.name }}</h3>
                    <div class="flex items-center gap-2 text-xs">
                        <!-- Agent Assignment Indicator -->
                        <span *ngIf="chat.assignedAgent" class="text-blue-400">
                            <i class="fas fa-user-tie"></i> {{ getAssignedAgentName(chat) }}
                        </span>
                        <!-- AI Status Indicator -->
                        <span *ngIf="chat.isAIEnabled" class="text-green-400">
                            <i class="fas fa-robot"></i> {{ 'chat.aiActive' | translate }}
                        </span>
                        <span *ngIf="!chat.isAIEnabled && chat.assignedAgent" class="text-yellow-400">
                            <i class="fas fa-pause"></i> {{ 'chat.aiPaused' | translate }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex gap-4 text-gray-400">
                <!-- AI Metadata Toggle Button -->
                <button
                    *ngIf="hasMetadata()"
                    (click)="isMetadataVisible = !isMetadataVisible; $event.stopPropagation()"
                    class="hover:text-gray-200 relative"
                    [class.text-blue-400]="isMetadataVisible"
                    [title]="'AI Collected Information'">
                    <i class="fas fa-database"></i>
                    <span *ngIf="!isMetadataVisible" class="absolute -top-1 -right-1 w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                </button>
                <button
                    (click)="openTemplateSender(chat); $event.stopPropagation()"
                    class="hover:text-gray-200"
                    [title]="'chat.sendTemplateMessage' | translate">
                    <i class="fas fa-file-alt"></i>
                </button>
                <button
                    (click)="openCustomerModal(chat); $event.stopPropagation()"
                    class="hover:text-gray-200"
                    [title]="(chat.customerId ? 'chat.editCustomer' : 'chat.createCustomer') | translate">
                    <i class="fas" [ngClass]="chat.customerId ? 'fa-user-edit' : 'fa-user-plus'"></i>
                </button>
                <button class="hover:text-gray-200"><i class="fas fa-search"></i></button>
                <button class="hover:text-gray-200"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>

        <!-- Agent Control Buttons -->
        <div class="px-4 pb-2 flex gap-2">
            <!-- Take Over Button (show when not assigned) -->
            <button
                *ngIf="!chat.assignedAgent"
                (click)="takeoverChat(chat.id)"
                [disabled]="!canTakeOver() || isTakingOver"
                [title]="(canTakeOver() ? 'chat.takeOverConversation' : 'chat.enableAutoAssignToTakeOver') | translate"
                class="px-4 py-1.5 text-white text-sm rounded-md transition-colors flex items-center gap-2"
                [ngClass]="canTakeOver() && !isTakingOver ? 'bg-blue-600 hover:bg-blue-700 cursor-pointer' : 'bg-gray-600 cursor-not-allowed opacity-50'">
                <i class="fas" [ngClass]="isTakingOver ? 'fa-spinner fa-spin' : 'fa-hand-paper'"></i>
                {{ (isTakingOver ? 'chat.takingOver' : 'chat.takeOver') | translate }}
            </button>

            <!-- Resume AI Button (show when assigned to current agent) -->
            <button
                *ngIf="chat.assignedAgent && isAssignedToMe(chat)"
                (click)="releaseChat(chat.id)"
                [disabled]="isReleasingChat"
                class="px-4 py-1.5 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas" [ngClass]="isReleasingChat ? 'fa-spinner fa-spin' : 'fa-robot'"></i>
                {{ (isReleasingChat ? 'chat.releasing' : 'chat.resumeAI') | translate }}
            </button>

            <!-- Info Badge (show when assigned to another agent) -->
            <div
                *ngIf="chat.assignedAgent && !isAssignedToMe(chat)"
                class="px-4 py-1.5 bg-gray-700 text-gray-300 text-sm rounded-md flex items-center gap-2">
                <i class="fas fa-info-circle"></i>
                {{ 'chat.assignedTo' | translate }} {{ getAssignedAgentFirstName(chat) }}
            </div>
        </div>

        <!-- AI Collected Metadata Display (Collapsible) -->
        <div *ngIf="hasMetadata() && isMetadataVisible"
             class="mx-4 mb-2 bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-3 animate-slideDown">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fas fa-database text-blue-400"></i>
                    <h4 class="text-sm font-semibold text-blue-300">AI Collected Information</h4>
                </div>
                <button
                    (click)="isMetadataVisible = false"
                    class="text-gray-400 hover:text-gray-200 text-xs">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
                <div *ngFor="let item of threadMetadata.metadata | keyvalue"
                     class="bg-gray-800 bg-opacity-50 rounded p-2">
                    <div class="text-gray-400 mb-1">{{ item.key }}</div>
                    <div class="text-gray-200 font-medium">{{ item.value }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div class="flex-1 overflow-y-auto p-4 custom-scrollbar flex flex-col gap-1" #scrollContainer>
        <app-message-bubble *ngFor="let message of chat.messages" [message]="message"></app-message-bubble>

        <!-- Typing Indicator -->
        <div *ngIf="isTyping" class="flex justify-start mb-2">
            <div class="bg-whatsapp-gray rounded-lg p-3 shadow-sm">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Input -->
    <div class="bg-whatsapp-gray p-2 shrink-0 z-10">
        <app-message-input [chat]="chat"></app-message-input>
    </div>

    <!-- Customer Modal -->
    <app-customer-modal
        [isOpen]="isCustomerModalOpen"
        [phoneNumber]="selectedPhoneNumber"
        [customerId]="selectedCustomerId"
        (closeModal)="closeCustomerModal()"
        (customerSaved)="onCustomerSaved($event)">
    </app-customer-modal>

    <!-- Template Sender Modal -->
    <app-template-sender
        *ngIf="isTemplateSenderOpen && selectedCustomerIdForTemplate"
        [customerId]="selectedCustomerIdForTemplate"
        (close)="closeTemplateSender()"
        (templateSent)="onTemplateSent()">
    </app-template-sender>

    <!-- Conversation Summary Modal -->
    <div *ngIf="isSummaryModalOpen && conversationSummary"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
         (click)="closeSummaryModal()">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden"
             (click)="$event.stopPropagation()">
            <!-- Modal Header -->
            <div class="bg-blue-600 text-white px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-info-circle text-2xl"></i>
                    <div>
                        <h3 class="text-lg font-semibold">{{ 'chat.conversationContext' | translate }}</h3>
                        <p class="text-sm text-blue-100">{{ 'chat.reviewBeforeTakeover' | translate }}</p>
                    </div>
                </div>
                <button (click)="closeSummaryModal()" class="hover:bg-blue-700 rounded-full p-2 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)] custom-scrollbar">
                <!-- Brief Summary -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2 flex items-center gap-2">
                        <i class="fas fa-file-alt text-blue-500"></i>
                        {{ 'chat.quickSummary' | translate }}
                    </h4>
                    <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
                        {{ conversationSummary.briefSummary }}
                    </p>
                </div>

                <!-- Key Information Grid -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">{{ 'chat.customerIntent' | translate }}</div>
                        <div class="text-sm font-medium text-gray-800 dark:text-gray-100">
                            {{ conversationSummary.customerIntent }}
                        </div>
                    </div>
                    <div class="bg-yellow-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">{{ 'chat.sentiment' | translate }}</div>
                        <div class="text-sm font-medium text-gray-800 dark:text-gray-100 capitalize">
                            <i class="fas" [ngClass]="{
                                'fa-smile text-green-500': conversationSummary.sentiment === 'satisfied',
                                'fa-meh text-yellow-500': conversationSummary.sentiment === 'neutral',
                                'fa-frown text-orange-500': conversationSummary.sentiment === 'concerned',
                                'fa-angry text-red-500': conversationSummary.sentiment === 'frustrated'
                            }"></i>
                            {{ conversationSummary.sentiment }}
                        </div>
                    </div>
                    <div class="bg-green-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">{{ 'chat.category' | translate }}</div>
                        <div class="text-sm font-medium text-gray-800 dark:text-gray-100 capitalize">
                            {{ conversationSummary.estimatedCategory }}
                        </div>
                    </div>
                    <div class="bg-red-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">{{ 'chat.urgency' | translate }}</div>
                        <div class="text-sm font-medium text-gray-800 dark:text-gray-100 capitalize">
                            <i class="fas" [ngClass]="{
                                'fa-exclamation-circle text-red-500': conversationSummary.urgency === 'urgent' || conversationSummary.urgency === 'high',
                                'fa-exclamation-triangle text-yellow-500': conversationSummary.urgency === 'medium',
                                'fa-info-circle text-blue-500': conversationSummary.urgency === 'low'
                            }"></i>
                            {{ conversationSummary.urgency }}
                        </div>
                    </div>
                </div>

                <!-- Current Status -->
                <div class="mb-6 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-2 flex items-center gap-2">
                        <i class="fas fa-clipboard-check text-green-500"></i>
                        {{ 'chat.currentStatus' | translate }}
                    </h4>
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        {{ conversationSummary.currentStatus }}
                    </p>
                </div>

                <!-- Key Points -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-3 flex items-center gap-2">
                        <i class="fas fa-list-ul text-purple-500"></i>
                        {{ 'chat.keyPointsToKnow' | translate }}
                    </h4>
                    <ul class="space-y-2">
                        <li *ngFor="let point of conversationSummary.keyPoints"
                            class="flex items-start gap-2 text-sm text-gray-700 dark:text-gray-300">
                            <i class="fas fa-check-circle text-green-500 mt-0.5"></i>
                            <span>{{ point }}</span>
                        </li>
                    </ul>
                </div>

                <!-- Suggested Approach -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-700 dark:to-gray-600 p-4 rounded-lg">
                    <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-100 mb-2 flex items-center gap-2">
                        <i class="fas fa-lightbulb text-yellow-500"></i>
                        {{ 'chat.suggestedApproach' | translate }}
                    </h4>
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        {{ conversationSummary.suggestedApproach }}
                    </p>
                </div>

                <!-- Conversation Stats -->
                <div *ngIf="conversationSummary.metadata" class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-600">
                    <div class="flex items-center gap-6 text-xs text-gray-500 dark:text-gray-400">
                        <div class="flex items-center gap-1">
                            <i class="fas fa-comments"></i>
                            <span>{{ conversationSummary.metadata.totalMessages }} {{ 'chat.messages' | translate }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <i class="fas fa-robot"></i>
                            <span>{{ conversationSummary.metadata.aiMessagesCount }} {{ 'chat.fromAI' | translate }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <i class="fas fa-user"></i>
                            <span>{{ conversationSummary.metadata.customerMessagesCount }} {{ 'chat.fromCustomer' | translate }}</span>
                        </div>
                        <div *ngIf="conversationSummary.metadata.conversationAge" class="flex items-center gap-1">
                            <i class="fas fa-clock"></i>
                            <span>{{ conversationSummary.metadata.conversationAge }} {{ 'chat.minAgo' | translate }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 flex justify-end gap-3">
                <button (click)="closeSummaryModal()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-check"></i>
                    {{ 'chat.gotIt' | translate }}
                </button>
            </div>
        </div>
    </div>
</div>

<ng-template #noChat>
    <div
        class="flex flex-col items-center justify-center h-full text-gray-400 bg-whatsapp-dark border-b-[6px] border-whatsapp-green">
        <div class="text-center">
            <h2 class="text-3xl font-light text-gray-200 mb-4">{{ 'chat.whatsappWeb' | translate }}</h2>
            <p class="text-sm">{{ 'chat.whatsappWebDescription' | translate }}</p>
        </div>
    </div>
</ng-template>
